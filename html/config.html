<html>

<head>
	<meta charset="utf-8">
	<title>Configuracion</title>

	<!-- CSS Scripts ---------------->
	<link href="../assets/css/bootstrap.min.css" rel="stylesheet">
	<link href="../assets/icons/FontAwesome/css/fontawesome.css" rel="stylesheet">
	<link href="../assets/icons/FontAwesome/css/brands.css" rel="stylesheet">
	<link href="../assets/icons/FontAwesome/css/solid.css" rel="stylesheet">

	<script href="../js/popper.min.js"></script>
	<script href="../js/bootstrap.min.js"></script>

	<style>
		body {
			margin: 0;
			font-family: -apple-system, BlinkMacSystemFont, "Inter UI", "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
			font-size: 1rem;
			line-height: 1.5;
			color: #01070F;
			background-color: #f3f4f5;
		}
	</style>

</head>

<body>
	<div class="container">
		<div class="page-header">
			<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
				<h3 align="center" style="color: #01070F">
					Configuracion Inicial
				</h3>
				<br>
			</div>
		</div>

		<form class="form-signin">
			<div class="text-center mb-4">
				<label style="margin:10px">Empresa</label>
				<select class="rol-empleado custom-select mr-sm-3 text-right">
					<option value="3">Prestamo Féliz</option>
				</select>
			</div>

			<div class="form-label-group">
				<label class="mr-sm-3" style="margin:10px">Sucursal</label>
				<input type="text" class="form-control" id="idSucursal"><br>
			</div>

			<div class="form-label-group">
				<input onclick="inicial()" class="btn btn-lg btn-primary btn-block" value="Guardar" type="button">
			</div>

		</form>
		<p class="mt-5 mb-3 text-muted text-center">&copy; Grupo GarSa - Préstamo Feliz</p>


	</div>

	<script type="text/javascript">
		const $ = require('jquery');
		const colors = require('colors');
		const macaddress = require('macaddress');
		const ipc = require('electron').ipcRenderer;
		const Cry = require('cryptr');
		const log = require('electron-log');
		const request = require('request');
		const os = require('os');
		const fs = require('fs');
		const base64 = require('base-64');
		const hash = require('sha256');
		const exec = require('child_process').exec;
		const mkdirp = require('mkdirp');
		const dateTime = require('node-datetime');

		const nombrepattern = "[0-9]{1,9}$"
		const jw = 'MGJsaXZpYXQzIw=='


		const ConfigPATH = os.homedir + '/.config/Control-Asistencia';
		const ConfigFile = ConfigPATH + '/config';
		const logFile = ConfigPATH + '/app.log'

		log.debug('Redirigiendo log'.cyan + ' ---> '.magenta + logFile.yellow)
		log.transports.file.file = logFile

        const readline = require('readline');
        
        try {
            const readInterface = readline.createInterface({
                input: fs.createReadStream(ConfigFilejs),
                output: process.stdout,
                console: false
            });    
            try{				
                readInterface.on('line', function (line) {
                    let [confP, confS] = line.split(';');
                    let [x, IPP] = confP.split('=');
                    let [z, IPS] = confS.split('=');
                    urlP = IPP; 
                    urlL = IPS;
                });
            }catch{
                urlL = null;
                urlP = null;
            }
    
        } catch (e) {
            log.error(String(e).red);
            log.info('[-] ERROR al obtener la configuracio,, la aplicaicon se reiniciará');
            log.silly('');
            urlL = null;
            urlP = null;
        }
		function checkInput(idInput, pattern) {
			switch (pattern) {
				case 'sucursal':
					var bool = $(idSucursal).val().match(nombrepattern) ? true : false;
					break;
			}
			return bool
		}

		function inicial() {
			var id_empresa = $("option:selected").val();
			var id_sucursal = $("#idSucursal").val();

			var configToRegist = 'idE:3,idS:' + id_sucursal

			log.debug('Configuracion a registrar: ' + configToRegist);

			registrarConfig(configToRegist, id_empresa, id_sucursal, 1);
		}


		function registrarConfig(configToRegist, idEm, idSuc, inicial) {
			log.debug('Registrando...'.blue);
			macaddress.one(function (err, m) {
				var requestmac = require('request');
				var XMLTextomac = '<s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/">\
				<s:Body>\
				<RegistraMAC xmlns="http://tempuri.org/">\
					<idempresa>' + idEm + '</idempresa>\
					<sucursal>' + idSuc + '</sucursal>\
					<mac>' + m + '</mac>\
				</RegistraMAC>\
				</s:Body>\
			</s:Envelope>'
			log.debug(XMLTextomac.blue);
				
				requestmac({
					url: urlL,
					method: "POST",
					headers: {
						"content-type": "text/xml",
						"SOAPAction": "http://tempuri.org/ISolicitud/RegistraMAC",
					},
					body: XMLTextomac
				}, function (error, response, body) {
					log.debug(String(body).green)

					var request = require('request');
					var XMLTexto = '<s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/">\
			<s:Body>\
				<RegistraConfig xmlns="http://tempuri.org/">\
					<mac>' + m + '</mac>\
					<config>' + configToRegist + '</config>\
				</RegistraConfig>\
			</s:Body>\
			</s:Envelope>'
			log.debug(XMLTexto.blue);

					// alert(body);
					request({
						url: urlL,
						method: "POST",
						headers: {
							"content-type": "text/xml",
							"SOAPAction": "http://tempuri.org/ISolicitud/RegistraConfig",
						},
						body: XMLTexto
					}, function (error, response, body) {
						log.debug(String(body).yellow);
										try {
									const rde = base64.decode(jw)
									const cryptr = new Cry(rde)

									const encryptedString = cryptr.encrypt(String(configToRegist))
									fs.writeFile(ConfigFile, encryptedString, function (err) {
										if (err) log.error(err)
										log.info('Archivo de configuracion creado: '.gray + configPATH.yellow)
									})
							} catch (e) {
								log.error(String(e).red)
							}

							alert(
								'La aplicación se reiniciará para guardar la configuracion.\nPresione ACEPTAR para continuar.')
							const ipc = require('electron').ipcRenderer
							ipc.sendSync('config', 'Reiniciando aplicacion...')

					})
				})
			})
		}
	</script>
</body>



</html>